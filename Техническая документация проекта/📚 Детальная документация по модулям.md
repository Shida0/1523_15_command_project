### Внешние API

### Модуль: `external_apis/sbdb_api.py`

**Назначение модуля:** Клиент для получения данных о потенциально опасных астероидах (PHA) из NASA SBDB API (первый уровень данных).

**Зависимости:**

- `logging`, `time`, `typing`
    
- `requests`
    
- `astroquery.jplsbdb.SBDB`
    
- `.space_math.get_size_by_albedo`, `get_size_by_h_mag`
    

**Экспортируемые сущности:** `NASASBDBClient`

**Класс `NASASBDBClient`:**

- **Назначение класса:** Клиент для получения данных об астероидах через гибридный подход
    
- **Конструктор:**
    
    - **Параметры:** Нет
        
- **Методы:**
    
    - **`get_asteroids(limit: Optional[int] = None) -> List[Dict[str, Any]]`**
        
        - **Назначение:** Получает данные об астероидах
            
        - **Параметры:**
            
            - `limit` (Optional[int]) — ограничение количества записей (по умолчанию ~3000)
                
        - **Возвращаемое значение:** Список словарей с данными астероидов
            
        - **Исключения:** `requests.exceptions.RequestException`, общие исключения
            
        - **Процесс:**
            
            1. Запрос к SBDB Query API для получения списка PHA
                
            2. Последовательный запрос детальных данных через astroquery
                
            3. Парсинг и преобразование данных
                
            4. Возврат структурированных данных
                
    - **`_parse_sbdb_to_model(sbdb_data: Dict, designation: str) -> Optional[Dict[str, Any]]`**
        
        - **Назначение:** Парсинг сырых данных SBDB в формат модели
            
        - **Параметры:**
            
            - `sbdb_data` (Dict) — сырые данные от SBDB
                
            - `designation` (str) — обозначение астероида
                
        - **Возвращаемое значение:** Словарь с преобразованными данными или None при ошибке
            

**Пример использования:**

```python

from external_apis import NASASBDBClient

client = NASASBDBClient()
asteroids = client.get_asteroids(limit=100)
for asteroid in asteroids[:5]:
    print(f"{asteroid['designation']}: диаметр {asteroid['estimated_diameter_km']} км")
```

**Важные детали реализации:**

- Использует задержку 2 секунды между запросами для уважения к API
    
- Обрабатывает различные форматы данных (astropy.units.Quantity, строки с единицами)
    
- Автоматически рассчитывает диаметр если данные отсутствуют
    
- Использует стандартное альбедо 0.15 при отсутствии данных
    

---

### Модуль: `external_apis/cad_api.py`

**Назначение модуля:** Клиент для получения данных о сближениях через NASA CAD API (второй уровень данных).

**Зависимости:**

- `json`, `logging`, `time`, `re`, `datetime`, `typing`
    
- `requests`, `enum.Enum`
    
- `.get_date.GetDate`
    

**Экспортируемые сущности:**

- `CADErrorCode` (Enum)
    
- `CADError` (Exception)
    
- `CADURLBuilder`
    
- `CADJSONExtractor`
    
- `CADDataParser`
    
- `CombinedCADClient`
    

**Класс `CADErrorCode` (Enum):**

- **Назначение:** Коды ошибок для CAD API
    
- **Значения:**
    
    - `NETWORK_ERROR = "CAD001"` — сетевая ошибка
        
    - `JSON_PARSE_ERROR = "CAD002"` — ошибка парсинга JSON
        
    - `DATE_PARSE_ERROR = "CAD003"` — ошибка парсинга даты
        
    - `SELENIUM_ERROR = "CAD004"` — ошибка Selenium
        
    - `API_ERROR = "CAD005"` — общая ошибка API
        
    - `DATA_PARSE_ERROR = "CAD006"` — ошибка обработки данных
        
    - `CONFIG_ERROR = "CAD007"` — ошибка конфигурации
        
    - `VALIDATION_ERROR = "CAD008"` — ошибка валидации
        

**Класс `CADError` (Exception):**

- **Назначение:** Кастомное исключение для ошибок CAD API
    
- **Конструктор:**
    
    - **Параметры:**
        
        - `code` (CADErrorCode) — код ошибки
            
        - `message` (str) — сообщение об ошибке
            
        - `details` (Optional[Dict]) — дополнительная информация
            

**Класс `CADURLBuilder`:**

- **Назначение:** Построение URL для запросов к CAD API
    
- **Статические методы:**
    
    - **`build_url(date_min: str, date_max: str, max_distance_au: float) -> str`**
        
        - **Назначение:** Строит URL для CAD API с параметрами
            
        - **Параметры:**
            
            - `date_min` (str) — минимальная дата (YYYY-MM-DD)
                
            - `date_max` (str) — максимальная дата или +D
                
            - `max_distance_au` (float) — максимальное расстояние
                
        - **Возвращаемое значение:** Полный URL строкой
            
        - **Исключения:** `CADError` при ошибке валидации
            

**Класс `CADJSONExtractor`:**

- **Назначение:** Извлечение JSON данных из различных источников
    
- **Статические методы:**
    
    - **`extract_from_page(page_source: str) -> Optional[str]`**
        
        - **Назначение:** Извлекает JSON из исходного кода страницы
            
        - **Возвращаемое значение:** JSON строка или None если не найдено
            
        - **Исключения:** `CADError` при критической ошибке извлечения
            

**Класс `CADDataParser` (наследует `GetDate`):**

- **Назначение:** Парсинг и обработка данных CAD API
    
- **Методы:**
    
    - **`process_cad_response(cad_data: Dict, filter_ids: Optional[Set[str]] = None) -> Dict[str, List[Dict[str, Any]]]`**
        
        - **Назначение:** Обработка данных из CAD API
            
        - **Параметры:**
            
            - `cad_data` (Dict) — данные от CAD API
                
            - `filter_ids` (Optional[Set[str]]) — ID для фильтрации
                
        - **Возвращаемое значение:** Словарь с данными о сближениях
            
        - **Исключения:** `CADError` при ошибке обработки данных
            

**Класс `CombinedCADClient`:**

- **Назначение:** Основной клиент для получения данных о сближениях
    
- **Конструктор:**
    
    - **Параметры:**
        
        - `request_delay` (float) — задержка между запросами (по умолчанию 3.0)
            
- **Методы:**
    
    - **`get_close_approaches(asteroid_ids: Optional[List[str]] = None, start_date: Optional[datetime] = None, end_date: Optional[datetime] = None, max_distance_au: float = 0.05) -> Dict[str, List[Dict[str, Any]]]`**
        
        - **Назначение:** Получает сближения через Selenium или прямой запрос
            
        - **Параметры:**
            
            - `asteroid_ids` — список ID астероидов для фильтрации
                
            - `start_date` — начальная дата (по умолчанию текущая дата)
                
            - `end_date` — конечная дата (по умолчанию +10 лет)
                
            - `max_distance_au` — максимальное расстояние в AU (по умолчанию 0.05)
                
        - **Возвращаемое значение:** Данные о сближениях сгруппированные по астероидам
            
        - **Исключения:** `CADError` при критической ошибке
            
        - **Процесс:**
            
            1. Прямой запрос к CAD API
                
            2. При неудаче — запрос через Selenium
                
            3. Фильтрация по asteroid_ids
                
            4. Парсинг и преобразование данных
                

**Пример использования:**

```python

from external_apis import CombinedCADClient
from datetime import datetime, timedelta

client = CombinedCADClient()
approaches = client.get_close_approaches(
    asteroid_ids=['99942', '101955'],
    start_date=datetime.now(),
    end_date=datetime.now() + timedelta(days=3650),
    max_distance_au=0.05
)
```

---

### Модуль: `external_apis/sentry_api.py`

**Назначение модуля:** Модуль для работы с NASA Sentry API. Точный анализ объектов с ненулевой вероятностью столкновения с Землей.

**Зависимости:**

- `logging`, `requests`
    
- `typing`, `dataclasses`, `datetime`
    

**Экспортируемые сущности:**

- `SentryImpactRisk` (dataclass)
    
- `SentryImpactRiskAnalyzer` (класс)
    
- `get_current_impact_risks` (функция)
    
- `check_asteroid_risk` (функция)
    

**Dataclass `SentryImpactRisk`:**

- **Назначение:** Данные об объекте с риском столкновения из системы NASA Sentry
    
- **Поля:**
    
    - `designation` (str) — обозначение астероида
        
    - `fullname` (str) — полное название
        
    - `ip` (float) — кумулятивная вероятность столкновения
        
    - `ts_max` (int) — максимальное значение по Туринской шкале (0-10)
        
    - `ps_max` (float) — максимальное значение по Палермской шкале
        
    - `diameter` (float) — расчетный диаметр в км
        
    - `v_inf` (float) — скорость на бесконечности (км/с)
        
    - `h` (float) — абсолютная звездная величина
        
    - И другие поля для локализации и метаданных
        

**Класс `SentryImpactRiskAnalyzer`:**

- **Назначение:** Анализатор рисков на основе NASA Sentry API (Sentry-II)
    
- **Конструктор:**
    
    - **Параметры:**
        
        - `timeout` (int) — таймаут HTTP-запросов (по умолчанию 30)
            
        - `enable_cache` (bool) — включить кэширование (по умолчанию True)
            
- **Методы:**
    
    - **`fetch_current_impact_risks() -> List[SentryImpactRisk]`**
        
        - **Назначение:** Получает актуальные данные о рисках
            
        - **Возвращаемое значение:** Список объектов с рисками (только ts_max > 0)
            
    - **`fetch_object_details(designation: str) -> Optional[SentryImpactRisk]`**
        
        - **Назначение:** Получает детали конкретного объекта
            
        - **Параметры:** `designation` — обозначение астероида
            
        - **Возвращаемое значение:** Объект риска или None если не найден
            

**Функция `get_current_impact_risks(limit: Optional[int] = None) -> List[Dict[str, Any]]`:**

- **Назначение:** Основная функция для получения актуальных рисков
    
- **Параметры:** `limit` — ограничение количества объектов
    
- **Возвращаемое значение:** Список словарей с данными об угрозах
    

**Функция `check_asteroid_risk(designation: str) -> Dict[str, Any]`:**

- **Назначение:** Проверяет, представляет ли конкретный астероид угрозу
    
- **Параметры:** `designation` — обозначение астероида
    
- **Возвращаемое значение:** Словарь с оценкой риска
    

**Пример использования:**

```python

from external_apis import get_current_impact_risks, check_asteroid_risk

# Получить все текущие риски
risks = get_current_impact_risks(limit=10)

# Проверить конкретный астероид
risk_info = check_asteroid_risk("2023 DW")
```

---

### Модуль: `external_apis/get_date.py`

**Назначение модуля:** Точный парсинг дат из NASA CAD API.

**Зависимости:**

- `locale`, `datetime`, `logging`
    

**Экспортируемые сущности:** `GetDate` (класс)

**Класс `GetDate`:**

- **Назначение:** Класс для парсинга дат в формате NASA
    
- **Методы:**
    
    - **`_parse_cad_date_exact(cd_str: str) -> datetime`**
        
        - **Назначение:** Точный парсинг даты из поля 'cd' NASA CAD API
            
        - **Параметры:** `cd_str` — строка даты из поля 'cd'
            
        - **Возвращаемое значение:** datetime объект в UTC
            
        - **Исключения:** `ValueError` если строка не соответствует формату
            
        - **Форматы:**
            
            - Основной: `YYYY-MMM-DD HH:MM` (например, `2029-Apr-13 21:46`)
                
            - Альтернативные: с секундами, полными названиями месяцев, ISO-формат
                

---

### Модуль: `external_apis/space_math.py`

**Назначение модуля:** Математические расчеты для астероидов.

**Экспортируемые сущности:**

- `get_size_by_albedo` (функция)
    
- `get_size_by_h_mag` (функция)
    

**Функции:**

- **`get_size_by_albedo(albedo: float, h_mag: float) -> float`**
    
    - **Назначение:** Вычисляет диаметр астероида на основе альбедо и абсолютной звёздной величины
        
    - **Параметры:**
        
        - `albedo` — альбедо (должно быть > 0)
            
        - `h_mag` — абсолютная звездная величина
            
    - **Возвращаемое значение:** Диаметр в километрах
        
    - **Формула:** `1329 / (albedo ** 0.5) * (10 ** (-0.2 * h_mag))`
        
    - **Исключения:** `ValueError` если albedo <= 0
        
- **`get_size_by_h_mag(h_mag: float) -> float`**
    
    - **Назначение:** Вычисляет диаметр астероида с использованием стандартного альбедо
        
    - **Параметры:** `h_mag` — абсолютная звездная величина
        
    - **Возвращаемое значение:** Диаметр в километрах
        
    - **Примечание:** Использует альбедо 0.15 по умолчанию
        

---

## Утилиты

### Модуль: `utils/get_data.py`

**Назначение модуля:** Упрощенный интерфейс для работы с NASA SBDB API.

**Зависимости:**

- `logging`, `typing`
    
- `external_apis.sbdb_api.NASASBDBClient`
    

**Экспортируемые сущности:** `get_asteroid_data` (функция)

**Функции:**

- **`get_asteroid_data(limit: Optional[int] = None) -> List[Dict[str, Any]]`**
    
    - **Назначение:** Основная функция для получения данных о потенциально опасных астероидах
        
    - **Параметры:** `limit` — ограничение количества астероидов
        
    - **Возвращаемое значение:** Список словарей с данными астероидов
        
    - **Исключения:** Логирует ошибки, возвращает пустой список при ошибках
        

---

### Модуль: `utils/get_approaches.py`

**Назначение модуля:** Мониторинг сближений астероидов с Землей.

**Зависимости:**

- `logging`, `datetime`, `typing`
    
- `external_apis.CombinedCADClient`
    

**Экспортируемые сущности:** `get_current_close_approaches` (функция)

**Функции:**

- **`get_current_close_approaches(asteroids: List[Dict[str, Any]], days: int = 3650, max_distance_au: int = 0.05) -> List[Dict]`**
    
    - **Назначение:** Получение всех сближений от сегодняшнего дня до определенного дня в будущем
        
    - **Параметры:**
        
        - `asteroids` — список потенциально опасных астероидов
            
        - `days` — количество дней для поиска (по умолчанию 3650 = 10 лет)
            
        - `max_distance_au` — максимальная дистанция сближения (по умолчанию 0.05 а.е.)
            
    - **Возвращаемое значение:** Список всех сближений потенциально-опасных астероидов
        
    - **Процесс:**
        
        1. Сбор ID всех PHA астероидов
            
        2. Bulk-запрос к CAD API
            
        3. Фильтрация и сортировка результатов
            

---

### Модуль: `utils/get_treat.py`

**Назначение модуля:** Упрощенный интерфейс для работы с Sentry API.

**Зависимости:**

- `logging`, `typing`
    
- `external_apis.sentry_api.get_current_impact_risks`, `check_asteroid_risk`
    

**Экспортируемые сущности:**

- `get_all_approaches` (функция)
    
- `get_approach_details` (функция)
    

**Функции:**

- **`get_all_approaches(limit: Optional[int] = None) -> List[Dict[str, Any]]`**
    
    - **Назначение:** Получить все актуальные сближения с Землей (объекты с ненулевым ts_max)
        
    - **Параметры:** `limit` — ограничение количества объектов
        
    - **Возвращаемое значение:** Список словарей с данными о сближениях
        
- **`get_approach_details(designation: str) -> Dict[str, Any]`**
    
    - **Назначение:** Получить детальную информацию о конкретном сближении
        
    - **Параметры:** `designation` — обозначение астероида
        
    - **Возвращаемое значение:** Словарь с детальной информацией

## Модели базы данных

#### Модуль: `models/base.py`

**Назначение модуля:** Базовый класс для всех моделей SQLAlchemy с автоматическим именованием таблиц и общими полями.

**Зависимости:**

- `sqlalchemy.ext.asyncio.AsyncAttrs`
    
- `sqlalchemy.orm.DeclarativeBase, Mapped, mapped_column`
    
- `sqlalchemy.DateTime, func`
    
- `re`
    

**Экспортируемые сущности:** `Base`

**Класс `Base`:**

- **Назначение класса:** Абстрактный базовый класс для всех моделей
    
- **Особенности:**
    
    - Автоматическое преобразование CamelCase в snake_case для имен таблиц
        
    - Добавление множественного числа к именам таблиц
        
    - Общие поля: `id`, `created_at`, `updated_at`
        
    - Поддержка асинхронной работы через `AsyncAttrs`
        

---

#### Модуль: `models/asteroid.py`

**Назначение модуля:** Модель для хранения данных о потенциально опасных астероидах (PHA).

**Экспортируемые сущности:** `AsteroidModel`

**Класс `AsteroidModel`:**

- **Назначение класса:** Представляет таблицу `asteroid_models` в БД
    
- **Основные поля:**
    
    - `designation: Mapped[str]` — обозначение NASA (уникальное)
        
    - `name: Mapped[Optional[str]]` — собственное название
        
    - `perihelion_au: Mapped[Optional[float]]` — расстояние перигелия
        
    - `aphelion_au: Mapped[Optional[float]]` — расстояние афелия
        
    - `earth_moid_au: Mapped[Optional[float]]` — минимальное расстояние с Землей
        
    - `absolute_magnitude: Mapped[float]` — абсолютная звездная величина
        
    - `estimated_diameter_km: Mapped[float]` — расчетный диаметр
        
    - `accurate_diameter: Mapped[bool]` — флаг точности диаметра
        
    - `albedo: Mapped[float]` — альбедо
        
- **Связи:**
    
    - `close_approaches: Mapped[List['CloseApproachModel']]` — сближения астероида
        
- **Ограничения:**
    
    - Уникальность `designation`
        
    - Проверка диапазона альбедо (0, 1]
        
    - Проверка что афелий > перигелия
        

---

#### Модуль: `models/close_approach.py`

**Назначение модуля:** Модель для хранения рассчитанных сближений астероидов с Землей.

**Экспортируемые сущности:** `CloseApproachModel`

**Класс `CloseApproachModel`:**

- **Назначение класса:** Представляет таблицу `close_approach_models`
    
- **Основные поля:**
    
    - `asteroid_id: Mapped[int]` — ссылка на астероид
        
    - `approach_time: Mapped[datetime]` — время сближения
        
    - `distance_au: Mapped[float]` — расстояние в астрономических единицах
        
    - `distance_km: Mapped[float]` — расстояние в километрах (авторасчет)
        
    - `velocity_km_s: Mapped[float]` — относительная скорость
        
    - `asteroid_designation: Mapped[str]` — обозначение астероида
        
- **Особенности:**
    
    - Автоматический расчет `distance_km` из `distance_au`
        
    - Хранение только сближений ближе 1 а.е.
        
    - Уникальное ограничение: `asteroid_id` + `approach_time`
        

---

#### Модуль: `models/threat_assessment.py`

**Назначение модуля:** Модель для хранения оценок опасности сближений.

**Экспортируемые сущности:** `ThreatAssessmentModel`

**Класс `ThreatAssessmentModel`:**

- **Назначение класса:** Представляет таблицу `threat_assessment_models`
    
- **Основные поля:**
    
    - `approach_id: Mapped[int]` — ссылка на сближение (уникальная)
        
    - `threat_level: Mapped[str]` — уровень угрозы
        
    - `impact_category: Mapped[str]` — категория воздействия
        
    - `energy_megatons: Mapped[float]` — энергия в мегатоннах тротила
        
    - `calculation_input_hash: Mapped[str]` — хеш входных данных
        
- **Ограничения:**
    
    - `threat_level`: 'низкий', 'средний', 'высокий', 'критический'
        
    - `impact_category`: 'локальный', 'региональный', 'глобальный'
        
    - `energy_megatons >= 0`
        

---

## Контроллеры

#### Модуль: `controllers/base_controller.py`

**Назначение модуля:** Базовый контроллер с общими CRUD-операциями для всех моделей.

**Экспортируемые сущности:** `BaseController`, `ModelType`

**Класс `BaseController` (Generic):**

- **Назначение класса:** Предоставляет универсальные методы работы с БД
    
- **Основные методы:**
    
    - `create()` — создание записи
        
    - `get_by_id()` — получение по ID
        
    - `update()` — обновление записи
        
    - `delete()` — удаление записи
        
    - `filter()` — универсальная фильтрация с поддержкой операторов
        
    - `bulk_create()` — массовое создание
        
    - `search()` — поиск по текстовым полям
        

**Поддерживаемые операторы фильтрации:**

- `__eq` — равно
    
- `__gt` — больше
    
- `__lt` — меньше
    
- `__ge` — больше или равно
    
- `__le` — меньше или равно
    
- `__in` — в списке
    
- `__like` — поиск по шаблону
    
- `__ilike` — регистронезависимый поиск
    

---

#### Модуль: `controllers/asteroid_controller.py`

**Назначение модуля:** Специализированный контроллер для операций с астероидами.

**Экспортируемые сущности:** `AsteroidController`

**Класс `AsteroidController` (наследует `BaseController[AsteroidModel]`):**

- **Специализированные методы:**
    
    - `get_pha_asteroids()` — только опасные астероиды
        
    - `search_by_name()` — поиск по названию
        
    - `get_asteroids_by_diameter_range()` — фильтрация по диаметру
        
    - `get_statistics()` — статистика по астероидам
        

---

#### Модуль: `controllers/approach_controller.py`

**Назначение модуля:** Контроллер для работы со сближениями астероидов с Землей.

**Экспортируемые сущности:** `ApproachController`

**Класс `ApproachController` (наследует `BaseController[CloseApproachModel]`):**

- **Специализированные методы:**
    
    - `get_by_asteroid()` — все сближения астероида
        
    - `get_approaches_in_period()` — сближения в периоде
        
    - `get_closest_approaches()` — ближайшие сближения
        
    - `bulk_create_approaches()` — массовое создание сближений
        
    - `get_approaches_with_threats()` — сближения с оценками угроз
        

---

#### Модуль: `controllers/threat_controller.py`

**Назначение модуля:** Контроллер для работы с оценками угроз сближений.

**Экспортируемые сущности:** `ThreatController`

**Класс `ThreatController` (наследует `BaseController[ThreatAssessmentModel]`):**

- **Специализированные методы:**
    
    - `get_by_approach_id()` — оценка для сближения
        
    - `get_high_threats()` — высокие угрозы
        
    - `update_assessment()` — обновление оценки
        
    - `get_statistics()` — статистика по оценкам
        
    - `get_threats_by_asteroid()` — оценки для астероида
        

---

## Вспомогательные модули

#### Модуль: `models/engine.py`

**Назначение модуля:** Настройка подключения к базе данных PostgreSQL.

**Экспортируемые сущности:**

- `async_engine` — асинхронный движок SQLAlchemy
    
- `AsyncSessionLocal` — фабрика асинхронных сессий
    
- `get_async_session()` — генератор сессий для FastAPI
    
- `close_async_engine()` — функция закрытия соединения
    

---

#### Модуль: `models/get_db_config.py`

**Назначение модуля:** Формирование конфигурации подключения к БД.

**Функции:**

- `get_async_db_url()` — создание асинхронного URL
    
- `get_async_dsn()` — возврат DSN строки
    

**Зависит от переменных окружения:**

- `POSTGRES_USER`, `POSTGRES_PASSWORD`
    
- `POSTGRES_HOST`, `POSTGRES_PORT`, `POSTGRES_DB`