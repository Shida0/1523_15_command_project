### Модуль: `models/base.py`

**Назначение модуля**: Базовый класс для всех моделей SQLAlchemy с общими полями и настройками.

**Зависимости**:

- `sqlalchemy.ext.asyncio.AsyncAttrs`
    
- `sqlalchemy.orm.DeclarativeBase, Mapped, mapped_column`
    
- `sqlalchemy.DateTime, func`
    
- `re`
    

**Экспортируемые сущности**: `Base`

**Класс `Base`**:

- **Назначение класса**: Абстрактный базовый класс для всех моделей, обеспечивающий автоматическое именование таблиц, общие поля и методы.
    
- **Конструктор**: Автоматически наследуется от `DeclarativeBase`.
    
- **Атрибуты класса**:
    
    - `__abstract__ = True`
        
    - `id: Mapped[int]` - первичный ключ, автоинкремент
        
    - `created_at: Mapped[DateTime]` - время создания записи
        
    - `updated_at: Mapped[DateTime]` - время последнего обновления
        
- **Методы**:
    
    - `__tablename__()`: Автоматически генерирует имя таблицы в snake_case (например, `AsteroidModel` → `asteroid_models`)
        
    - `__repr__()`: Строковое представление объекта для отладки
        

### Модуль: `models/asteroid.py`

**Назначение модуля**: Модель для хранения данных о потенциально опасных астероидов (PHA).

**Зависимости**:

- `sqlalchemy.CheckConstraint, Float, String, Boolean`
    
- `sqlalchemy.orm.Mapped, mapped_column, relationship`
    
- `models.base.Base`
    

**Экспортируемые сущности**: `AsteroidModel`

**Класс `AsteroidModel`**:

- **Назначение класса**: Представляет таблицу `asteroid_models` в БД, хранит все данные об астероидах.
    
- **Поля модели**:
    
    - `mpc_number: Mapped[int]` - уникальный номер из каталога MPC
        
    - `name: Mapped[Optional[str]]` - собственное название астероида
        
    - `designation: Mapped[Optional[str]]` - временное обозначение
        
    - `perihelion_au: Mapped[float]` - расстояние перигелия (а.е.)
        
    - `aphelion_au: Mapped[float]` - расстояние афелия (а.е.)
        
    - `earth_moid_au: Mapped[float]` - минимальное расстояние пересечения орбит с Землей
        
    - `absolute_magnitude: Mapped[float]` - абсолютная звездная величина (H)
        
    - `estimated_diameter_km: Mapped[float]` - расчетный диаметр (км)
        
    - `accurate_diameter: Mapped[bool]` - флаг точности диаметра
        
    - `albedo: Mapped[float]` - альбедо (отражательная способность)
        
    - `is_neo: Mapped[bool]` - является ли околоземным объектом
        
    - `is_pha: Mapped[bool]` - является ли потенциально опасным
        
- **Связи**:
    
    - `close_approaches: Mapped[List['CloseApproachModel']]` - связь один-ко-многим со сближениями
        
- **Ограничения** (`__table_args__`):
    
    - `aphelion_au > perihelion_au` - афелий всегда больше перигелия
        
    - `earth_moid_au >= 0` - расстояние MOID неотрицательное
        
    - `perihelion_au > 0` - перигелий положительный
        
- **Конструктор**: Выполняет валидацию данных (альбедо в диапазоне (0,1], афелий > перигелия)
    

**Пример использования**:

``` python
async with AsyncSessionLocal() as session:
    asteroid = AsteroidModel(
        mpc_number=433,
        name="Eros",
        perihelion_au=1.13,
        aphelion_au=1.78,
        earth_moid_au=0.15,
        absolute_magnitude=10.4,
        estimated_diameter_km=16.84,
        accurate_diameter=True,
        albedo=0.25,
        is_neo=True,
        is_pha=False
    )
    session.add(asteroid)
    await session.commit()
```

### Модуль: `models/close_approach.py`

**Назначение модуля**: Модель для хранения рассчитанных сближений астероидов с Землей.

**Экспортируемые сущности**: `CloseApproachModel`

**Класс `CloseApproachModel`**:

- **Назначение класса**: Представляет таблицу `close_approach_models`, хранит данные о будущих сближениях.
    
- **Поля модели**:
    
    - `asteroid_id: Mapped[int]` - внешний ключ к астероиду
        
    - `approach_time: Mapped[datetime]` - точное время сближения
        
    - `distance_au: Mapped[float]` - расстояние в астрономических единицах
        
    - `distance_km: Mapped[float]` - расстояние в километрах (авторасчет)
        
    - `velocity_km_s: Mapped[float]` - относительная скорость (км/с)
        
    - `calculation_batch_id: Mapped[str]` - идентификатор партии расчета
        
- **Связи**:
    
    - `asteroid: Mapped['AsteroidModel']` - связь многие-к-одному с астероидом
        
    - `threat_assessment: Mapped['ThreatAssessmentModel']` - связь один-к-одному с оценкой угрозы
        
- **Конструктор**: Автоматически рассчитывает `distance_km` из `distance_au`, валидирует что сближение ближе 1 а.е.
    

### Модуль: `models/threat_assessment.py`

**Назначение модуля**: Модель для хранения оценок опасности сближений.

**Экспортируемые сущности**: `ThreatAssessmentModel`

**Класс `ThreatAssessmentModel`**:

- **Назначение класса**: Представляет таблицу `threat_assessment_models`, хранит результаты оценки опасности.
    
- **Поля модели**:
    
    - `approach_id: Mapped[int]` - внешний ключ к сближению (уникальный)
        
    - `threat_level: Mapped[str]` - уровень угрозы: 'низкий', 'средний', 'высокий', 'критический'
        
    - `impact_category: Mapped[str]` - категория воздействия: 'локальный', 'региональный', 'глобальный'
        
    - `energy_megatons: Mapped[float]` - энергия воздействия в мегатоннах тротила
        
    - `calculation_input_hash: Mapped[str]` - хеш входных данных для отслеживания изменений
        
- **Ограничения**:
    
    - `threat_level` только из разрешенных значений
        
    - `impact_category` только из разрешенных значений
        
    - `energy_megatons >= 0`
        
- **Методы**:
    
    - `_calculate_input_hash()`: Вычисляет SHA-256 хеш входных данных для отслеживания изменений
        

### Модуль: `controllers/base_controller.py`

**Назначение модуля**: Базовый класс контроллера с общими CRUD-операциями для всех моделей.

**Зависимости**:

- `sqlalchemy.ext.asyncio.AsyncSession`
    
- `sqlalchemy.select, update, delete, func, and_, or_`
    
- `models.base.Base`
    

**Экспортируемые сущности**: `BaseController`, `ModelType`

**Класс `BaseController`** (Generic):

- **Назначение класса**: Предоставляет универсальные методы работы с БД для любой модели.
    
- **Конструктор**:
    
    - `__init__(self, model: Type[ModelType])` - инициализирует контроллер с указанной моделью
        
- **Основные методы**:
    
    - `create(session, data) -> ModelType`: Создание записи
        
    - `get_by_id(session, id) -> Optional[ModelType]`: Получение по ID
        
    - `update(session, id, update_data) -> Optional[ModelType]`: Обновление записи
        
    - `delete(session, id) -> bool`: Удаление записи
        
    - `get_all(session, skip=0, limit=100) -> List[ModelType]`: Пагинированный список
        
    - `count(session) -> int`: Подсчет записей
        
    - `filter(session, filters, skip=0, limit=100, order_by=None, order_desc=False) -> List[ModelType]`: Универсальная фильтрация
        
    - `bulk_create(session, data_list, conflict_action="update", conflict_fields=None) -> Tuple[int, int]`: Массовое создание
        
    - `search(session, search_term, search_fields, skip=0, limit=50) -> List[ModelType]`: Поиск по текстовым полям
        
    - `bulk_delete(session, filters) -> int`: Массовое удаление
        

**Пример использования фильтрации**:

```python
# Простые фильтры
asteroids = await controller.filter(session, {"is_pha": True})

# Расширенный синтаксис
asteroids = await controller.filter(session, {
    "estimated_diameter_km__gt": 100,
    "estimated_diameter_km__lt": 500,
    "earth_moid_au__le": 0.05
})
```

### Модуль: `controllers/asteroid_controller.py`

**Назначение модуля**: Специализированный контроллер для операций с астероидами.

**Зависимости**: `BaseController`, `AsteroidModel`

**Экспортируемые сущности**: `AsteroidController`

**Класс `AsteroidController`** (наследует `BaseController[AsteroidModel]`):

- **Назначение класса**: Предоставляет методы для работы с астероидами.
    
- **Конструктор**: `__init__()` - инициализирует контроллер для модели `AsteroidModel`.
    
- **Специализированные методы**:
    
    - `get_by_mpc_number(session, mpc_number) -> Optional[AsteroidModel]`: Поиск по номеру MPC
        
    - `get_pha_asteroids(session, skip=0, limit=100) -> List[AsteroidModel]`: Только опасные астероиды
        
    - `search_by_name(session, search_term, skip=0, limit=50) -> List[AsteroidModel]`: Поиск по названию
        
    - `get_asteroids_by_diameter_range(session, min_diameter=None, max_diameter=None, skip=0, limit=100) -> List[AsteroidModel]`: Фильтрация по диаметру
        
    - `get_statistics(session) -> Dict[str, Any]`: Статистика по астероидам
        

### Модуль: `controllers/approach_controller.py`

**Назначение модуля**: Контроллер для работы со сближениями астероидов с Землей.

**Класс `ApproachController`** (наследует `BaseController[CloseApproachModel]`):

- **Специализированные методы**:
    
    - `get_by_asteroid(session, asteroid_id, skip=0, limit=100) -> List[CloseApproachModel]`: Все сближения астероида
        
    - `get_approaches_in_period(session, start_date, end_date, max_distance=None, skip=0, limit=100) -> List[CloseApproachModel]`: Сближения в периоде
        
    - `get_closest_approaches(session, limit=10) -> List[CloseApproachModel]`: Ближайшие сближения
        
    - `get_closest_by_distance(session, limit=10) -> List[CloseApproachModel]`: Самые близкие по расстоянию
        
    - `bulk_create_approaches(session, approaches_data, calculation_batch_id) -> int`: Массовое создание сближений
        
    - `delete_old_approaches(session, cutoff_date) -> int`: Удаление устаревших сближений
        
    - `get_approaches_with_threats(session, threat_level=None, start_date=None, end_date=None, skip=0, limit=100) -> List[CloseApproachModel]`: Сближения с оценками угроз
        

### Модуль: `controllers/threat_controller.py`

**Назначение модуля**: Контроллер для работы с оценками угроз сближений.

**Класс `ThreatController`** (наследует `BaseController[ThreatAssessmentModel]`):

- **Специализированные методы**:
    
    - `get_by_approach_id(session, approach_id) -> Optional[ThreatAssessmentModel]`: Оценка для сближения
        
    - `get_high_threats(session, limit=20) -> List[ThreatAssessmentModel]`: Высокие угрозы
        
    - `update_assessment(session, approach_id, new_data) -> Optional[ThreatAssessmentModel]`: Обновление оценки
        
    - `bulk_create_assessments(session, assessments_data) -> int`: Массовое создание оценок
        
    - `get_statistics(session) -> Dict[str, Any]`: Статистика по оценкам
        
    - `get_threats_by_asteroid(session, asteroid_id) -> List[ThreatAssessmentModel]`: Оценки для астероида
        

### Модуль: `utils/space_math.py`

**Назначение модуля**: Математические расчеты для астероидов.

**Экспортируемые функции**:

- `get_size_by_albedo(albedo: float, h_mag: float) -> float`: Расчет диаметра по альбедо и абсолютной величине
    
    - **Формула**: `1329 / (albedo ** 0.5) * (10 ** (-0.2 * h_mag))`
        
    - **Возвращает**: Диаметр в километрах
        
- `get_size_by_h_mag(h_mag: float) -> float`: Расчет диаметра по стандартному альбедо (0.15)
    
    - **Возвращает**: Диаметр в километрах
        
- `count_danger(diameter_km, distance_au, velocity_km_s) -> dict`: Оценка опасности астероида
    
    - **Параметры**:
        
        - `diameter_km`: Диаметр в километрах
            
        - `distance_au`: Расстояние до Земли в астрономических единицах
            
        - `velocity_km_s`: Относительная скорость в км/с
            
    - **Возвращает**: Словарь с оценкой угрозы, категорией воздействия и энергией
        

**Пример оценки опасности**:

```python
result = count_danger(
    diameter_km=0.5,      # 500 метров
    distance_au=0.02,     # 3 млн км
    velocity_km_s=18.5    # 18.5 км/с
)
```

### Модуль: `utils/get_data.py`

**Назначение модуля**: Получение данных об астероидах из внешних источников.

**Зависимости**: `astroquery.mpc.MPC`, `astroquery.jplsbdb.SBDB`

**Экспортируемые функции**:

- `get_neo() -> list`: Получение данных обо всех околоземных объектах (NEO)
    
    - **Процесс**:
        
        1. Запрос к Minor Planet Center (MPC) для получения списка астероидов
            
        2. Фильтрация по перигелию (≤ 1.3 а.е.) для выделения NEO
            
        3. Запрос к JPL SBDB для получения физических параметров
            
        4. Расчет диаметра (точный или приближенный)
            
        5. Формирование структурированных данных
            
    - **Возвращает**: Список словарей с данными об астероидах
        

**Пример структуры данных**:

```python
{
    "mpc_number": 433,
    "name": "Eros",
    "designation": "1898 DQ",
    "perihelion_au": 1.13,
    "aphelion_au": 1.78,
    "earth_moid_au": 0.15,
    "is_neo": True,
    "is_pha": False,
    "absolute_magnitude": 10.4,
    "estimated_diameter_km": 16.84,
    "accurate_diameter": True,
    "albedo": 0.25
}
```

### Модуль: `utils/monitoring.py`

**Назначение модуля**: Мониторинг текущих сближений астероидов с Землей.

**Зависимости**: `astroquery.jplhorizons.Horizons`

**Экспортируемые функции**:

- `get_current_close_approaches(data: list, days: int = 30) -> list`: Получение сближений в ближайшие дни
    
    - **Процесс**:
        
        1. Фильтрация потенциально опасных астероидов (PHA)
            
        2. Запрос эфемерид к JPL Horizons для периода (текущая дата + N дней)
            
        3. Поиск сближений ближе 0.05 а.е. (~7.5 млн км)
            
        4. Сортировка по расстоянию
            
    - **Возвращает**: Список словарей с данными о сближениях
        

### Модуль: `utils/write_to_db.py`

**Назначение модуля**: Запись данных об астероидах в базу данных.

**Зависимости**: `AsteroidController`, `AsyncSessionLocal`, `get_neo`

**Экспортируемые функции**:

- `async_write_data()`: Асинхронная функция записи данных
    
    - **Процесс**:
        
        1. Получение данных об NEO через `get_neo()`
            
        2. Создание асинхронной сессии БД
            
        3. Массовое создание записей через `AsteroidController.bulk_create()`
            
- `write_data()`: Синхронная обертка для запуска асинхронной функции
    

### Модуль: `update_db.py`

**Назначение модуля**: Скрипт для ежедневного обновления базы данных.

**Основная функция**:

- `main()`: Оркестрирует процесс обновления:
    
    1. Инициализация логирования
        
    2. Создание сессии БД
        
    3. Запуск обновления данных
        
    4. Логирование результатов
        
    5. Обработка ошибок и прерываний
        

**Запуск**: `python update_db.py`

### Модуль: `models/engine.py`

**Назначение модуля**: Настройка подключения к базе данных PostgreSQL.

**Зависимости**: `sqlalchemy.ext.asyncio`, `get_db_config.get_async_db_url`

**Экспортируемые сущности**:

- `async_engine`: Асинхронный движок SQLAlchemy
    
- `AsyncSessionLocal`: Фабрика асинхронных сессий
    
- `get_async_session()`: Генератор сессий
    
- `close_async_engine()`: Функция для корректного закрытия соединения
    

### Модуль: `models/get_db_config.py`

**Назначение модуля**: Формирование конфигурации подключения к БД.

**Экспортируемые функции**:

- `get_async_db_url() -> URL`: Создание асинхронного URL для PostgreSQL
    
- `get_async_dsn() -> str`: Возвращает DSN строку в текстовом формате
    

**Зависит от переменных окружения**:

- `POSTGRES_USER`, `POSTGRES_PASSWORD`, `POSTGRES_HOST`, `POSTGRES_PORT`, `POSTGRES_DB`