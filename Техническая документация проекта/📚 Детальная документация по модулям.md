### Уровень 1: Получение данных об астероидах

#### Модуль: `utils/get_data.py`

**Назначение модуля:** Получение данных о потенциально опасных астероидах (PHA) из NASA SBDB API (первый уровень).

**Зависимости:**

- `logging`, `time`, `typing`
    
- `requests`
    
- `astroquery.jplsbdb.SBDB`
    
- `.space_math.get_size_by_albedo`, `get_size_by_h_mag`
    

**Экспортируемые сущности:** `NASASBDBClient`

**Класс `NASASBDBClient`:**

- **Назначение класса:** Клиент для получения данных об астероидах через гибридный подход:
    
    1. SBDB Query API для получения списка PHA
        
    2. astroquery.jplsbdb для детальных данных каждого астероида
        
- **Конструктор:**
    
    - **Параметры:** Нет
        
- **Методы:**
    
    - **`get_asteroids(limit: Optional[int] = None) -> List[Dict[str, Any]]`**
        
        - **Назначение:** Получает данные об астероидах
            
        - **Параметры:**
            
            - `limit` (Optional[int]) — ограничение количества записей (по умолчанию ~3000)
                
        - **Возвращаемое значение:** Список словарей с данными астероидов
            
        - **Процесс:**
            
            1. Запрос к SBDB Query API для получения списка PHA
                
            2. Последовательный запрос детальных данных через astroquery
                
            3. Парсинг и преобразование данных
                
            4. Возврат структурированных данных
                
    - **`_parse_sbdb_to_model(sbdb_data: Dict, designation: str) -> Optional[Dict[str, Any]]`**
        
        - **Назначение:** Парсинг сырых данных SBDB в формат модели
            
        - **Параметры:**
            
            - `sbdb_data` (Dict) — сырые данные от SBDB
                
            - `designation` (str) — обозначение астероида
                
        - **Возвращаемое значение:** Словарь с преобразованными данными или None при ошибке
            

**Пример использования:**

``` python

from utils.get_data import NASASBDBClient

client = NASASBDBClient()
# Получить первые 100 PHA астероидов
asteroids = client.get_asteroids(limit=100)

# Вывести информацию об астероидах
for asteroid in asteroids[:5]:
    print(f"{asteroid['designation']}: {asteroid['name']}")
    print(f"  Диаметр: {asteroid['estimated_diameter_km']} км")
    print(f"  Перигелий: {asteroid['perihelion_au']} а.е.")
```

**Важные детали реализации:**

- Использует задержку 2 секунды между запросами для уважения к API
    
- Обрабатывает различные форматы данных (astropy.units.Quantity, строки с единицами)
    
- Автоматически рассчитывает диаметр если данные отсутствуют
    

---

### Уровень 2: Получение данных о сближениях

#### Модуль: `utils/cad_api.py`

**Назначение модуля:** Клиент для получения данных о сближениях через NASA CAD API (второй уровень).

**Зависимости:**

- `json`, `logging`, `time`, `re`, `datetime`, `typing`
    
- `requests`, `enum.Enum`
    
- `.get_date.GetDate`
    

**Экспортируемые сущности:**

- `CADErrorCode` (Enum)
    
- `CADError` (Exception)
    
- `CADURLBuilder`
    
- `CADJSONExtractor`
    
- `CADDataParser`
    
- `CombinedCADClient`
    

**Класс `CADErrorCode` (Enum):**

- **Назначение:** Коды ошибок для CAD API
    
- **Значения:**
    
    - `NETWORK_ERROR = "CAD001"`
        
    - `JSON_PARSE_ERROR = "CAD002"`
        
    - `DATE_PARSE_ERROR = "CAD003"`
        
    - `SELENIUM_ERROR = "CAD004"`
        
    - `API_ERROR = "CAD005"`
        
    - `DATA_PARSE_ERROR = "CAD006"`
        
    - `CONFIG_ERROR = "CAD007"`
        
    - `VALIDATION_ERROR = "CAD008"`
        

**Класс `CADError` (Exception):**

- **Назначение:** Кастомное исключение для ошибок CAD API
    
- **Конструктор:**
    
    - **Параметры:**
        
        - `code` (CADErrorCode) — код ошибки
            
        - `message` (str) — сообщение об ошибке
            
        - `details` (Optional[Dict]) — дополнительная информация
            

**Класс `CADURLBuilder`:**

- **Назначение:** Построение URL для запросов к CAD API
    
- **Статические методы:**
    
    - **`build_url(date_min: str, date_max: str, max_distance_au: float) -> str`**
        
        - **Назначение:** Строит URL для CAD API с параметрами
            
        - **Параметры:**
            
            - `date_min` (str) — минимальная дата (YYYY-MM-DD)
                
            - `date_max` (str) — максимальная дата или +D
                
            - `max_distance_au` (float) — максимальное расстояние
                
        - **Возвращаемое значение:** Полный URL строкой
            

**Класс `CADJSONExtractor`:**

- **Назначение:** Извлечение JSON данных из различных источников
    
- **Статические методы:**
    
    - **`extract_from_page(page_source: str) -> Optional[str]`**
        
        - **Назначение:** Извлекает JSON из исходного кода страницы
            

**Класс `CADDataParser` (наследует `GetDate`):**

- **Назначение:** Парсинг и обработка данных CAD API
    
- **Методы:**
    
    - **`process_cad_response(cad_data: Dict, filter_ids: Optional[Set[str]] = None) -> Dict[str, List[Dict[str, Any]]]`**
        
        - **Назначение:** Обработка данных из CAD API
            
        - **Параметры:**
            
            - `cad_data` (Dict) — данные от CAD API
                
            - `filter_ids` (Optional[Set[str]]) — ID для фильтрации
                
        - **Возвращаемое значение:** Словарь с данными о сближениях
            

**Класс `CombinedCADClient`:**

- **Назначение:** Основной клиент для получения данных о сближениях
    
- **Конструктор:**
    
    - **Параметры:**
        
        - `request_delay` (float) — задержка между запросами (по умолчанию 3.0)
            
- **Методы:**
    
    - **`get_close_approaches(asteroid_ids: Optional[List[str]] = None, start_date: Optional[datetime] = None, end_date: Optional[datetime] = None, max_distance_au: float = 0.05) -> Dict[str, List[Dict[str, Any]]]`**
        
        - **Назначение:** Получает сближения через Selenium или прямой запрос
            
        - **Параметры:**
            
            - `asteroid_ids` — список ID астероидов для фильтрации
                
            - `start_date` — начальная дата
                
            - `end_date` — конечная дата
                
            - `max_distance_au` — максимальное расстояние в AU (по умолчанию 0.05)
                
        - **Процесс:**
            
            1. Прямой запрос к CAD API
                
            2. При неудаче — запрос через Selenium
                
            3. Фильтрация по asteroid_ids
                
            4. Парсинг и преобразование данных
                
    - **`_try_direct_request_variants(date_min: str, date_max: str, max_distance_au: float) -> Optional[Dict]`**
        
        - **Назначение:** Прямой запрос к API с разными вариантами параметров
            
    - **`_try_selenium_request(date_min: str, date_max: str, max_distance_au: float) -> Optional[Dict]`**
        
        - **Назначение:** Получение данных через Selenium
            

**Пример использования:**

```python
from utils.cad_api import CombinedCADClient
from datetime import datetime, timedelta

client = CombinedCADClient()

# Получить сближения для конкретных астероидов
approaches = client.get_close_approaches(
    asteroid_ids=['99942', '101955'],  # Apophis и Bennu
    start_date=datetime.now(),
    end_date=datetime.now() + timedelta(days=3650),
    max_distance_au=0.05
)

# Вывести информацию о сближениях
for asteroid_id, approach_list in approaches.items():
    print(f"Астероид {asteroid_id}: {len(approach_list)} сближений")
    for approach in approach_list[:3]:
        print(f"  {approach['approach_time']}: {approach['distance_au']} а.е.")
```

---

### Модели базы данных

#### Модуль: `models/base.py`

**Назначение модуля:** Базовый класс для всех моделей SQLAlchemy с автоматическим именованием таблиц и общими полями.

**Зависимости:**

- `sqlalchemy.ext.asyncio.AsyncAttrs`
    
- `sqlalchemy.orm.DeclarativeBase, Mapped, mapped_column`
    
- `sqlalchemy.DateTime, func`
    
- `re`
    

**Экспортируемые сущности:** `Base`

**Класс `Base`:**

- **Назначение класса:** Абстрактный базовый класс для всех моделей
    
- **Особенности:**
    
    - Автоматическое преобразование CamelCase в snake_case для имен таблиц
        
    - Добавление множественного числа к именам таблиц
        
    - Общие поля: `id`, `created_at`, `updated_at`
        
    - Поддержка асинхронной работы через `AsyncAttrs`
        

---

#### Модуль: `models/asteroid.py`

**Назначение модуля:** Модель для хранения данных о потенциально опасных астероидах (PHA).

**Экспортируемые сущности:** `AsteroidModel`

**Класс `AsteroidModel`:**

- **Назначение класса:** Представляет таблицу `asteroid_models` в БД
    
- **Основные поля:**
    
    - `designation: Mapped[str]` — обозначение NASA (уникальное)
        
    - `name: Mapped[Optional[str]]` — собственное название
        
    - `perihelion_au: Mapped[Optional[float]]` — расстояние перигелия
        
    - `aphelion_au: Mapped[Optional[float]]` — расстояние афелия
        
    - `earth_moid_au: Mapped[Optional[float]]` — минимальное расстояние с Землей
        
    - `absolute_magnitude: Mapped[float]` — абсолютная звездная величина
        
    - `estimated_diameter_km: Mapped[float]` — расчетный диаметр
        
    - `accurate_diameter: Mapped[bool]` — флаг точности диаметра
        
    - `albedo: Mapped[float]` — альбедо
        
- **Связи:**
    
    - `close_approaches: Mapped[List['CloseApproachModel']]` — сближения астероида
        
- **Ограничения:**
    
    - Уникальность `designation`
        
    - Проверка диапазона альбедо (0, 1]
        
    - Проверка что афелий > перигелия
        

---

#### Модуль: `models/close_approach.py`

**Назначение модуля:** Модель для хранения рассчитанных сближений астероидов с Землей.

**Экспортируемые сущности:** `CloseApproachModel`

**Класс `CloseApproachModel`:**

- **Назначение класса:** Представляет таблицу `close_approach_models`
    
- **Основные поля:**
    
    - `asteroid_id: Mapped[int]` — ссылка на астероид
        
    - `approach_time: Mapped[datetime]` — время сближения
        
    - `distance_au: Mapped[float]` — расстояние в астрономических единицах
        
    - `distance_km: Mapped[float]` — расстояние в километрах (авторасчет)
        
    - `velocity_km_s: Mapped[float]` — относительная скорость
        
    - `asteroid_designation: Mapped[str]` — обозначение астероида
        
- **Особенности:**
    
    - Автоматический расчет `distance_km` из `distance_au`
        
    - Хранение только сближений ближе 1 а.е.
        
    - Уникальное ограничение: `asteroid_id` + `approach_time`
        

---

#### Модуль: `models/threat_assessment.py`

**Назначение модуля:** Модель для хранения оценок опасности сближений.

**Экспортируемые сущности:** `ThreatAssessmentModel`

**Класс `ThreatAssessmentModel`:**

- **Назначение класса:** Представляет таблицу `threat_assessment_models`
    
- **Основные поля:**
    
    - `approach_id: Mapped[int]` — ссылка на сближение (уникальная)
        
    - `threat_level: Mapped[str]` — уровень угрозы
        
    - `impact_category: Mapped[str]` — категория воздействия
        
    - `energy_megatons: Mapped[float]` — энергия в мегатоннах тротила
        
    - `calculation_input_hash: Mapped[str]` — хеш входных данных
        
- **Ограничения:**
    
    - `threat_level`: 'низкий', 'средний', 'высокий', 'критический'
        
    - `impact_category`: 'локальный', 'региональный', 'глобальный'
        
    - `energy_megatons >= 0`
        

---

### Контроллеры

#### Модуль: `controllers/base_controller.py`

**Назначение модуля:** Базовый контроллер с общими CRUD-операциями для всех моделей.

**Экспортируемые сущности:** `BaseController`, `ModelType`

**Класс `BaseController` (Generic):**

- **Назначение класса:** Предоставляет универсальные методы работы с БД
    
- **Основные методы:**
    
    - `create()` — создание записи
        
    - `get_by_id()` — получение по ID
        
    - `update()` — обновление записи
        
    - `delete()` — удаление записи
        
    - `filter()` — универсальная фильтрация с поддержкой операторов
        
    - `bulk_create()` — массовое создание
        
    - `search()` — поиск по текстовым полям
        

**Поддерживаемые операторы фильтрации:**

- `__eq` — равно
    
- `__gt` — больше
    
- `__lt` — меньше
    
- `__ge` — больше или равно
    
- `__le` — меньше или равно
    
- `__in` — в списке
    
- `__like` — поиск по шаблону
    
- `__ilike` — регистронезависимый поиск
    

---

#### Модуль: `controllers/asteroid_controller.py`

**Назначение модуля:** Специализированный контроллер для операций с астероидами.

**Экспортируемые сущности:** `AsteroidController`

**Класс `AsteroidController` (наследует `BaseController[AsteroidModel]`):**

- **Специализированные методы:**
    
    - `get_pha_asteroids()` — только опасные астероиды
        
    - `search_by_name()` — поиск по названию
        
    - `get_asteroids_by_diameter_range()` — фильтрация по диаметру
        
    - `get_statistics()` — статистика по астероидам
        

---

#### Модуль: `controllers/approach_controller.py`

**Назначение модуля:** Контроллер для работы со сближениями астероидов с Землей.

**Экспортируемые сущности:** `ApproachController`

**Класс `ApproachController` (наследует `BaseController[CloseApproachModel]`):**

- **Специализированные методы:**
    
    - `get_by_asteroid()` — все сближения астероида
        
    - `get_approaches_in_period()` — сближения в периоде
        
    - `get_closest_approaches()` — ближайшие сближения
        
    - `bulk_create_approaches()` — массовое создание сближений
        
    - `get_approaches_with_threats()` — сближения с оценками угроз
        

---

#### Модуль: `controllers/threat_controller.py`

**Назначение модуля:** Контроллер для работы с оценками угроз сближений.

**Экспортируемые сущности:** `ThreatController`

**Класс `ThreatController` (наследует `BaseController[ThreatAssessmentModel]`):**

- **Специализированные методы:**
    
    - `get_by_approach_id()` — оценка для сближения
        
    - `get_high_threats()` — высокие угрозы
        
    - `update_assessment()` — обновление оценки
        
    - `get_statistics()` — статистика по оценкам
        
    - `get_threats_by_asteroid()` — оценки для астероида
        

---

### Вспомогательные модули

#### Модуль: `utils/space_math.py`

**Назначение модуля:** Математические расчеты для астероидов.

**Основные функции:**

- `get_size_by_albedo(albedo, h_mag)` — расчет диаметра по альбедо
    
- `get_size_by_h_mag(h_mag)` — расчет диаметра по стандартному альбедо
    
- `count_danger(diameter_km, distance_au, velocity_km_s)` — оценка опасности
    

**Формулы:**

- Диаметр: `1329 / sqrt(albedo) * 10^(-0.2 * H)`
    
- Энергия: `0.5 * mass * velocity^2`
    
- Масса: `density * (4/3 * π * (diameter/2)^3)`
    

---

#### Модуль: `utils/monitoring.py`

**Назначение модуля:** Мониторинг сближений астероидов с Землей.

**Основная функция:**

- `get_current_close_approaches(asteroids, days=3650, max_distance_au=0.05)`
    

**Процесс:**

1. Сбор ID всех PHA астероидов
    
2. Bulk-запрос к CAD API
    
3. Фильтрация и сортировка результатов
    
4. Возврат структурированных данных
    

---

#### Модуль: `utils/get_date.py`

**Назначение модуля:** Точный парсинг дат из NASA CAD API.

**Класс `GetDate`:**

- **Метод:** `_parse_cad_date_exact(cd_str)`
    
- **Формат NASA:** `YYYY-MMM-DD HH:MM` (например, `2029-Apr-13 21:46`)
    
- **Особенности:**
    
    - Установка английской локали для парсинга
        
    - Поддержка альтернативных форматов
        
    - Восстановление из поврежденных строк
        

---

#### Модуль: `models/engine.py`

**Назначение модуля:** Настройка подключения к базе данных PostgreSQL.

**Экспортируемые сущности:**

- `async_engine` — асинхронный движок SQLAlchemy
    
- `AsyncSessionLocal` — фабрика асинхронных сессий
    
- `get_async_session()` — генератор сессий для FastAPI
    
- `close_async_engine()` — функция закрытия соединения
    

---

#### Модуль: `models/get_db_config.py`

**Назначение модуля:** Формирование конфигурации подключения к БД.

**Функции:**

- `get_async_db_url()` — создание асинхронного URL
    
- `get_async_dsn()` — возврат DSN строки
    

**Зависит от переменных окружения:**

- `POSTGRES_USER`, `POSTGRES_PASSWORD`
    
- `POSTGRES_HOST`, `POSTGRES_PORT`, `POSTGRES_DB`