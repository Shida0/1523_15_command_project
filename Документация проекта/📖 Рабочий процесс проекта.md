## 🔄 Полный цикл сбора и обработки данных

### Общая схема работы

``` text
┌─────────────────────────────────────────────────────────────┐
│                    🌐 ВНЕШНИЕ ИСТОЧНИКИ NASA                |
├─────────────────────────────────────────────────────────────┤
│ 1. SBDB API → Список PHA астероидов (2000-3000 объектов)    │
│ 2. CAD API → Данные о сближениях (до 10 лет вперед)         │
│ 3. Sentry API → Оценки рисков столкновений                  │
└──────────────────────────────┬──────────────────────────────┘
                                │
┌──────────────────────────────▼──────────────────────────────┐
│                    ⚙️ ПРОЦЕСС ОБРАБОТКИ ДАННЫХ              |
├─────────────────────────────────────────────────────────────┤
│ 1. Фильтрация PHA астероидов                                │
│ 2. Пакетный запрос сближений для всех PHA                   │
│ 3. Расчет параметров угроз                                  │
│ 4. Валидация и преобразование данных                        │
└──────────────────────────────┬──────────────────────────────┘
                                │
┌──────────────────────────────▼──────────────────────────────┐
│                    💾 СОХРАНЕНИЕ В БАЗУ ДАННЫХ              │
├─────────────────────────────────────────────────────────────┤
│ 1. PostgreSQL через SQLAlchemy ORM                          │
│ 2. Асинхронные операции записи                              │
│ 3. Оптимизация с помощью bulk-операций                      │
│ 4. Обновление существующих записей                          │
└──────────────────────────────┬──────────────────────────────┘
                                │
┌──────────────────────────────▼──────────────────────────────┐
│                    📊 ПРЕДСТАВЛЕНИЕ ДАННЫХ                  │
├─────────────────────────────────────────────────────────────┤
│ 1. FastAPI для REST API                                     │
│ 2. Контроллеры для доступа к данным                         │
│ 3. Фильтрация, пагинация, сортировка                        │
└─────────────────────────────────────────────────────────────┘
```

## 🔄 Современный рабочий процесс проекта

### 1. 🔄 Обновление данных через UpdateService

Современный рабочий процесс проекта включает централизованное обновление данных через `UpdateService`, который координирует получение данных из всех трех источников NASA API:

**1.1. 🪨 Обновление астероидов:**
- Запрос к SBDB API для получения обновленной информации о PHA
- Валидация и нормализация данных
- Расчет недостающих параметров (диаметр, орбитальные параметры)
- Сохранение в `AsteroidModel` через `AsteroidService`

**1.2. 🌍 Обновление сближений:**
- Запрос к CAD API для получения новых данных о сближениях
- Фильтрация по уже известным астероидам
- Обработка и нормализация данных
- Сохранение в `CloseApproachModel` через `ApproachService`

**1.3. ⚠️ Обновление угроз:**
- Запрос к Sentry API для получения актуальных оценок угроз
- Локализация данных (русские описания)
- Расчет энергии воздействия и категорий угроз
- Сохранение в `ThreatAssessmentModel` через `ThreatService`

### 2. 🔄 Управление транзакциями

Проект использует шаблон Unit of Work для обеспечения согласованности данных:

- `UnitOfWork` управляет общей сессией базы данных
- Все изменения в рамках одной операции выполняются атомарно
- При ошибках выполняется откат всей транзакции
- Поддержка компенсирующих транзакций для сложных операций

### 3. 🔧 Обработка ошибок и отказоустойчивость

Проект реализует несколько паттернов отказоустойчивости:

**3.1. 🔄 Circuit Breaker:**
- Предотвращает повторные вызовы неработающих API
- Автоматическое восстановление после сбоев
- Настроенные параметры для NASA API

**3.2. 🛡️ Bulkhead:**
- Ограничение количества одновременных вызовов к API
- Изоляция ресурсов для разных типов операций
- Предотвращение перегрузки системы

**3.3. ⏱️ Timeout:**
- Ограничение времени ожидания ответа от API
- Предотвращение зависания вызовов
- Настроенные таймауты для разных API

### 4. Архитектурные особенности

**4.1. 🏗️ Доменная архитектура:**
- Каждый домен (астероиды, сближения, угрозы) изолирован
- Общая инфраструктура в `shared/infrastructure/`
- Повторное использование общих компонентов

**4.2. 📚 Слоистая архитектура:**
- Модели данных (models/)
- Схемы валидации (schemas/)
- Контроллеры доступа (controllers/)
- Бизнес-логика (services/)

### 5. Потоки данных между доменами

**5.1. 🔗 Связи между моделями:**
- `AsteroidModel` ←→ `CloseApproachModel` (один ко многим)
- `AsteroidModel` ←→ `ThreatAssessmentModel` (один к одному)
- Согласованность данных обеспечивается через транзакции

**5.2. 🔄 Обновление связанных данных:**
- При обновлении астероида могут обновляться связанные сближения
- Изменение данных может триггерить пересчет угроз
- Все операции выполняются в рамках одной транзакции

### 6. Планирование и автоматизация

**6.1. 📅 Регулярные обновления:**
- Планировщик обновлений через `UpdateService`
- Разные интервалы для разных типов данных
- Мониторинг состояния обновлений

**6.2. 📢 Уведомления:**
- Логирование всех операций
- Оповещения о сбоях
- Метрики производительности



## 📥 Шаг 1: Получение списка потенциально опасных астероидов (PHA)

### Детальный процесс:

**1.1. Инициализация клиента SBDB:**

```python
from external_apis.sbdb_api import NASASBDBClient
client = NASASBDBClient()
```

**1.2. Запрос к NASA SBDB Query API:**

- **URL:** `https://ssd-api.jpl.nasa.gov/sbdb_query.api`
    
- **Параметры:**
    
    - `fields`: 'pdes' (только обозначения)
        
    - `sb-group`: 'pha' (только потенциально опасные астероиды)
        
    - `limit`: 3000 (примерное количество PHA)
        
- **Ответ:** Список обозначений астероидов (~2000-3000 записей)
    

**1.3. Последовательный запрос детальных данных:**  
Для каждого обозначения выполняется:

1. Запрос к SBDB через astroquery
    
2. Парсинг ответа:
    
    - Орбитальные параметры (перигелий, афелий, MOID)
        
    - Физические характеристики (абсолютная магнитуда, альбедо, диаметр)
        
    - Класс орбиты (Apollo, Aten, Amor)
        

**1.4. Автоматический расчет недостающих данных:**  
Если диаметр не предоставлен NASA:

- Используется H-величина и альбедо
    
- Формула: `diameter = 1329 / sqrt(albedo) * 10^(-0.2*H)`
    
- Если альбедо неизвестно, используется стандартное значение 0.15
    

**1.5. Форматирование для модели:**

```python
asteroid_data = {
    'designation': '2023 DW',
    'name': None,  # если есть собственное название
    'perihelion_au': 0.89,
    'aphelion_au': 1.35,
    'earth_moid_au': 0.00078,
    'absolute_magnitude': 22.5,
    'estimated_diameter_km': 0.05,
    'accurate_diameter': True,  # если диаметр от NASA
    'albedo': 0.15,
    'orbit_class': 'Apollo',
    'orbit_id': '2345678'
}
```

**1.6. Задержка между запросами:**

- **2 секунды** между запросами к SBDB
    
- Предотвращение блокировки IP NASA
    
- Уважение к общедоступному API

## 🌍 Шаг 2: Получение данных о сближениях с Землей

### Схема запросов CAD API:

``` text
Начало
  │
  ├─▶ Прямой запрос к API
        ├─▶ Успех → Парсинг данных
        └─▶ Ошибка 
```

### Детальный процесс:

**2.1. Подготовка параметров:**

``` python
# Диапазон дат: сегодня → +10 лет (3650 дней)
start_date = datetime.now()
end_date = start_date + timedelta(days=3650)

# Максимальное расстояние: 0.05 а.е. (~7.5 млн км)
max_distance_au = 0.05

# Список ID астероидов для фильтрации
asteroid_ids = ['99942', '101955', '2023 DW']
```

**2.2. Построение URL для CAD API:**

```python
params = {
    'date-min': '2024-01-01',
    'date-max': '2034-01-01',  # или '+3650'
    'dist-max': '0.05',
    'body': 'Earth',
    'sort': 'dist',
    'fullname': 'true'
}
# Результат: https://ssd-api.jpl.nasa.gov/cad.api?date-min=2024-01-01&...
```

**2.3. Прямой запрос (основной метод):**

1. Отправка HTTP GET запроса
    
2. Ожидание ответа JSON
    
3. Проверка поля `'data'` на наличие записей
    
**2.5. Парсинг ответа CAD API:**

```python
# Структура ответа CAD API:
{
    "fields": ["des", "cd", "dist", "v_rel", "fullname"],
    "data": [
        ["2023 DW", "2023-Feb-14 19:46", 0.00078, 21.5, "2023 DW"],
        # ...
    ],
    "count": 125
}
```

**2.6. Преобразование данных:**  
Для каждой записи в `data`:

1. **Парсинг даты:** `"2023-Feb-14 19:46"` → `datetime(2023, 2, 14, 19, 46)`
    
2. **Конвертация единиц:** `distance_au` → `distance_km`
    
3. **Группировка по астероиду:** словарь `{designation: [approaches]}`
    

**2.7. Фильтрация по PHA астероидам:**

- Оставляем только сближения для астероидов из списка PHA
    
- Используется оптимизированная проверка по множествам (sets)
    
- Поддержка числовых ID в названиях астероидов

## ⚠️ Шаг 3: Оценка угроз через Sentry API

### Детальный процесс:

**3.1. Запрос к Sentry API:**

```python
# Основной запрос - объекты с риском столкновения
url = "https://ssd-api.jpl.nasa.gov/sentry.api?ip-min=1e-10"
```

**3.2. Фильтрация результатов:**

- **Только объекты с `ts_max > 0`** (ненулевая опасность по Туринской шкале)
    
- **Минимальная вероятность:** `1e-10` (1 к 10 миллиардам)
    
- **Актуальные данные:** последние наблюдения
    

**3.3. Парсинг данных Sentry:**

``` python
# Структура ответа Sentry:
{
    "data": [
        {
            "des": "2023 DW",
            "fullname": "2023 DW",
            "ip": 0.002,  # 0.2% вероятность
            "ts_max": 1,
            "ps_max": -1.5,
            "diameter": 0.05,
            "v_inf": 21.5,
            "h": 22.5,
            "last_obs": "2023-01-15",
            "data": [...]  # сценарии столкновений
        }
    ]
}
```

**3.4. Локализация и форматирование:**

1. **Туринская шкала:** числа → русский текст с цветами
    
    - `0`: "Нет риска (зелёный)"
        
    - `1-4`: "Заслуживает внимания (жёлтый/оранжевый)"
        
    - `5-10`: "Серьёзная угроза (красный)"
        
2. **Вероятность:** десятичная дробь → читаемый текст
    
    - `0.002` → "0.2% (1 к 500)"
        
    - `1e-6` → "0.0001% (1 к 1,000,000)"
        
3. **Уровень угрозы:** комбинированная оценка
    
    - Учитывает и Туринскую, и Палермскую шкалы
        
    - От "НУЛЕВОЙ" до "КРИТИЧЕСКИЙ"
        

**3.5. Кэширование результатов:**

- Время жизни кэша: 15 минут
    
- Ключи кэша: `current_impact_risks`, `object_{designation}`
    
- Снижение нагрузки на NASA API

## 💾 Шаг 4: Сохранение данных в базу данных

### Архитектура сохранения:

```text
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   Астероиды │────▶  Сближения  │────▶   Оценки    │
│   (PHA)     │    │   (CAD)     │    │   (Sentry)  │
└─────────────┘    └─────────────┘    └─────────────┘
       │                   │                   │
       ▼                   ▼                   ▼
┌─────────────────────────────────────────────────────┐
│               БАЗА ДАННЫХ POSTGRESQL                │
│  asteroid_models    │  close_approach_models │ ...  │
└─────────────────────────────────────────────────────┘
```

## 🏗️ Архитектура проекта

### Общая структура

Проект использует доменную архитектуру с выделением общей инфраструктуры:

- **domains/** - содержит бизнес-домены (asteroid, approach, threat)
- **shared/** - общие компоненты, которые могут использоваться несколькими доменами
- **services/** - основные сервисы приложения, включая UpdateService
- **infrastructure/** - базовые классы и компоненты (BaseService, BaseSchema, BaseController)

### Структура сервисов

Каждый домен имеет свои специализированные сервисы, но все они наследуются от общего Base Service, расположенного в shared.infrastructure.services.base_service. Это позволяет избежать дублирования кода и обеспечивает единообразную реализацию базовой логики.
Файл base_service.py теперь находится только в одном месте: shared/infrastructure/services/base_service.py

### Улучшения архитектуры

- Файл base_service.py теперь находится только в одном месте: shared/infrastructure/services/base_service.py
- Файл base_controller.py теперь находится только в одном месте: shared/infrastructure/controllers/base_controller.py
- Все дубликаты были удалены из доменных директорий и главной controllers/ директории
- Это устраняет дублирование кода и упрощает поддержку проекта



